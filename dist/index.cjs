"use strict";var e=require("fs"),t=require("path"),s=require("node-watch"),r=require("chalk");const o=e.promises;async function i(e,{ext:s,ignores:r=[],includes:c=[]},n,l=""){try{const a=t.resolve(e,l);if((await o.stat(a)).isDirectory()){const f=await o.readdir(a);for(const u of f){const f=t.resolve(a,u),g=await o.stat(f);if(g.isDirectory())r.map((s=>t.resolve(e,s))).includes(f)||(c&&c.length>0?c.map((s=>t.resolve(e,s))).includes(f)&&await i(e,{ext:s,ignores:r,includes:c},n,l?l+"/"+u:u):await i(e,{ext:s,ignores:r,includes:c},n,l?l+"/"+u:u));else if(g.isFile()){const e=t.parse(f).ext.substring(1);(!s||f.endsWith(`.${s}`)||s.split(",").includes(e))&&await n(f)}}}}catch(e){console.error(e)}}async function c(e){try{(await o.stat(e)).isDirectory()||await o.mkdir(e)}catch(t){await o.mkdir(e)}}var n={error:e=>{console.log(r.red(e))},success:e=>{console.log(r.green(e))},primary:e=>{console.log(r.blue(e))},info:e=>{console.log(r.grey(e))},log:e=>{console.log(e)},reg:e=>{const t=e.matchAll(/\$([^\$]*\$\#[0-9a-fA-F]{3,8})/);console.log(t)},dict:e=>{if("object"==typeof e)for(let t in e)console.log(`${r.blue(t)}: ${"string"==typeof e[t]?`'${e[t]}'`:e[t]}     `);else console.log(e)}};const l=e.promises;let a;async function f(e){const{watch:r,hot:o,ignores:u,includes:g,ext:p,rules:d,target:w,cssSplit:y}=e;n.primary("vnocss编译中......");const $=t.resolve(process.cwd(),w),h=t.parse($);await c(h.dir);let m="";return await i(t.resolve(process.cwd(),r),{ext:p,ignores:u,includes:g},(async function(e){let s="";const o=(await l.readFile(e)).toString(),i=[...o.matchAll(/class="([^"]*)"/g),...o.matchAll(/class='([^']*)'/g)];let n=[];for(let e of i)n=[...new Set([...n,...e[1].trim().split(/\s+/)])];for(let e of n)for(let t in d){let r=d[t];const o=new RegExp(`^${t}$`);if(!o.test(e))continue;const i=e.match(o);let c="";if("string"==typeof r){const e=[...r.matchAll(/\$val\[(\d+)\]/g)];for(let t of e){const e=+t[1];r=r.replace(t[0],i[e])}c=`.${i[0]}{${r}}`}else"function"===r&&(c=`.${i[0]}{${r(i)}}`);s.indexOf(c)<0&&(s+=c),m.indexOf(c)<0&&(m+=c)}const a=t.parse(e);if(y&&s){const e=a.dir.replace(t.resolve(process.cwd(),r),""),o=t.resolve(h.dir,"."+e,a.name+"_css.css");await c(t.parse(o).dir),await l.writeFile(o,s)}})),m&&await l.writeFile($,m),n.success("vnocss编译成功"),o&&function(e){const{watch:r,hot:o,ignores:i,includes:c,ext:l,rules:u,target:g,cssSplit:p}=e;a&&a.close(),a=s(t.resolve(process.cwd(),r),{recursive:!0,filter(e,t){if(Array.isArray(i))for(let s of i)if(new RegExp(`\\/${s}`).test(e))return t;if(Array.isArray(c)&&c.length>0){for(let t of c)if(new RegExp(`\\/${t}`).test(e)){let t=!1;for(let s of l.split(","))if(new RegExp(`\\.${s}`).test(e)){t=!0;break}return t}return t}let s=!1;for(let t of l.split(","))if(new RegExp(`\\.${t}`).test(e)){s=!0;break}return s}},(function(t,s){f(e)})),n.primary("监听文件中...")}(e),!0}module.exports=f;
