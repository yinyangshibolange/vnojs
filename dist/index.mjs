import e from"fs";import t from"path";import s from"node-watch";import o from"chalk";const r=e.promises;async function i(e,{ext:s,ignores:o=[],includes:c=[]},n,l=""){try{const a=t.resolve(e,l);if((await r.stat(a)).isDirectory()){const f=await r.readdir(a);for(const p of f){const f=t.resolve(a,p),g=await r.stat(f);if(g.isDirectory())o.map((s=>t.resolve(e,s))).includes(f)||(c&&c.length>0?c.map((s=>t.resolve(e,s))).includes(f)&&await i(e,{ext:s,ignores:o,includes:c},n,l?l+"/"+p:p):await i(e,{ext:s,ignores:o,includes:c},n,l?l+"/"+p:p));else if(g.isFile()){const e=t.parse(f).ext.substring(1);(!s||f.endsWith(`.${s}`)||s.split(",").includes(e))&&await n(f)}}}}catch(e){console.error(e)}}async function c(e){try{(await r.stat(e)).isDirectory()||await r.mkdir(e)}catch(t){await r.mkdir(e)}}var n={error:e=>{console.log(o.red(e))},success:e=>{console.log(o.green(e))},primary:e=>{console.log(o.blue(e))},info:e=>{console.log(o.grey(e))},log:e=>{console.log(e)},reg:e=>{const t=e.matchAll(/\$([^\$]*\$\#[0-9a-fA-F]{3,8})/);console.log(t)},dict:e=>{if("object"==typeof e)for(let t in e)console.log(`${o.blue(t)}: ${"string"==typeof e[t]?`'${e[t]}'`:e[t]}     `);else console.log(e)}};const l=e.promises;let a;async function f(e){const{watch:o,hot:r,ignores:p,includes:g,ext:u,rules:d,target:w,cssSplit:m}=e;n.primary("vnocss编译中......");const y=t.resolve(process.cwd(),w),$=t.parse(y);await c($.dir);let h="";return await i(t.resolve(process.cwd(),o),{ext:u,ignores:p,includes:g},(async function(e){let s="";const r=(await l.readFile(e)).toString(),i=[...r.matchAll(/class="([^"]*)"/g),...r.matchAll(/class='([^']*)'/g)];let n=[];for(let e of i)n=[...new Set([...n,...e[1].trim().split(/\s+/)])];for(let e of n)for(let t in d){let o=d[t];const r=new RegExp(`^${t}$`);if(!r.test(e))continue;const i=e.match(r);let c="";if("string"==typeof o){const e=[...o.matchAll(/\$val\[(\d+)\]/g)];for(let t of e){const e=+t[1];o=o.replace(t[0],i[e])}c=`.${i[0]}{${o}}`}else"function"===o&&(c=`.${i[0]}{${o(i)}}`);s.indexOf(c)<0&&(s+=c),h.indexOf(c)<0&&(h+=c)}const a=t.parse(e);if(m&&s){const e=a.dir.replace(t.resolve(process.cwd(),o),""),r=t.resolve($.dir,"."+e,a.name+"_css.css");await c(t.parse(r).dir),await l.writeFile(r,s)}})),h&&await l.writeFile(y,h),n.success("vnocss编译成功"),r&&function(e){const{watch:o,hot:r,ignores:i,includes:c,ext:l,rules:p,target:g,cssSplit:u}=e;a&&a.close(),a=s(t.resolve(process.cwd(),o),{recursive:!0,filter(e,t){if(Array.isArray(i))for(let s of i)if(new RegExp(`\\/${s}`).test(e))return t;if(Array.isArray(c)&&c.length>0){for(let t of c)if(new RegExp(`\\/${t}`).test(e)){let t=!1;for(let s of l.split(","))if(new RegExp(`\\.${s}`).test(e)){t=!0;break}return t}return t}let s=!1;for(let t of l.split(","))if(new RegExp(`\\.${t}`).test(e)){s=!0;break}return s}},(function(t,s){f(e)})),n.primary("监听文件中...")}(e),!0}export{f as default};
