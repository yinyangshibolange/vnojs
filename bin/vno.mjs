import e from"yargs";import t from"fs";import s from"path";import i from"node-watch";import o from"chalk";import r from"yargonaut";const n=t.promises;async function c(e,{ext:t,ignores:i=[],includes:o=[]},r,a=""){try{const l=s.resolve(e,a);if((await n.stat(l)).isDirectory()){const f=await n.readdir(l);for(const d of f){const f=s.resolve(l,d),g=await n.stat(f);if(g.isDirectory())i.map((t=>s.resolve(e,t))).includes(f)||(o&&o.length>0?o.map((t=>s.resolve(e,t))).includes(f)&&await c(e,{ext:t,ignores:i,includes:o},r,a?a+"/"+d:d):await c(e,{ext:t,ignores:i,includes:o},r,a?a+"/"+d:d));else if(g.isFile()){const e=s.parse(f).ext.substring(1);(!t||f.endsWith(`.${t}`)||t.split(",").includes(e))&&await r(f)}}}}catch(e){console.error(e)}}async function a(e){try{(await n.stat(e)).isDirectory()||await n.mkdir(e)}catch(t){await n.mkdir(e)}}var l={error:e=>{console.log(o.red(e))},success:e=>{console.log(o.green(e))},primary:e=>{console.log(o.blue(e))},info:e=>{console.log(o.grey(e))},log:e=>{console.log(e)},reg:e=>{const t=e.matchAll(/\$([^\$]*\$\#[0-9a-fA-F]{3,8})/);console.log(t)},dict:e=>{if("object"==typeof e)for(let t in e)console.log(`${o.blue(t)}: ${"string"==typeof e[t]?`'${e[t]}'`:e[t]}     `);else console.log(e)}};const f=t.promises;let d;async function g(e){const{watch:t,hot:o,ignores:r,includes:n,ext:p,rules:m,target:u,cssSplit:w}=e;l.primary("vnocss编译中......");const h=s.resolve(process.cwd(),u),v=s.parse(h);await a(v.dir);let y="";return await c(s.resolve(process.cwd(),t),{ext:p,ignores:r,includes:n},(async function(e){let i="";const o=(await f.readFile(e)).toString(),r=[...o.matchAll(/class="([^"]*)"/g),...o.matchAll(/class='([^']*)'/g)];let n=[];for(let e of r)n=[...new Set([...n,...e[1].trim().split(/\s+/)])];for(let e of n)for(let t in m){let s=m[t];const o=new RegExp(`^${t}$`);if(!o.test(e))continue;const r=e.match(o);let n="";if("string"==typeof s){const e=[...s.matchAll(/\$val\[(\d+)\]/g)];for(let t of e){const e=+t[1];s=s.replace(t[0],r[e])}n=`.${r[0]}{${s}}`}else"function"===s&&(n=`.${r[0]}{${s(r)}}`);i.indexOf(n)<0&&(i+=n),y.indexOf(n)<0&&(y+=n)}const c=s.parse(e);if(w&&i){const e=c.dir.replace(s.resolve(process.cwd(),t),""),o=s.resolve(v.dir,"."+e,c.name+"_css.css");await a(s.parse(o).dir),await f.writeFile(o,i)}})),y&&await f.writeFile(h,y),l.success("vnocss编译成功"),o&&function(e){const{watch:t,hot:o,ignores:r,includes:n,ext:c,rules:a,target:f,cssSplit:p}=e;d&&d.close(),d=i(s.resolve(process.cwd(),t),{recursive:!0,filter(e,t){if(Array.isArray(r))for(let s of r)if(new RegExp(`\\/${s}`).test(e))return t;if(Array.isArray(n)&&n.length>0){for(let t of n)if(new RegExp(`\\/${t}`).test(e)){let t=!1;for(let s of c.split(","))if(new RegExp(`\\.${s}`).test(e)){t=!0;break}return t}return t}let s=!1;for(let t of c.split(","))if(new RegExp(`\\.${t}`).test(e)){s=!0;break}return s}},(function(t,s){g(e)})),l.primary("监听文件中...")}(e),!0}var p={watch:"",hot:!0,ext:"html,vue",ignores:[],includes:[],target:"vnocss/vno.css",cssSplit:!1,rules:{}};const m=t.promises;r.help("3D-ASCII").helpStyle("green").style("blue"),e.command({command:"init",describe:"init your user space",builder:{dir:{alias:"dir",describe:"init config file paths",demand:!1,type:"string"}},async handler(e){const t=s.resolve(process.cwd(),e.dir||"","vno.config.js");let i=!1;try{(await m.stat(t)).isFile()&&(i=!0)}catch(e){}if(i)l.info("配置文件vno.config.js已存在，无需再次初始化");else{l.info("vno.config.js不存在，将创建初始配置");let e=s.resolve(__dirname,"../config/init.config.js");e="undefined"!=typeof require&&require.main===module?s.resolve(__dirname,"../config/init.config.cjs"):s.resolve(__dirname,"../config/init.config.mjs");const i=await m.readFile(e);await m.writeFile(t,i.toString())}}}).command({command:"start",describe:"start compile and watch html or other files! | 开始编译并监听文件变化！",builder:{config:{alias:"c",describe:"config file path, vno.config.json default | 指定配置文件,默认是vno.config.js",demand:!1,type:"string"},watch:{alias:"w",describe:"watched base directory path | 监听的文件夹路径，相对于根文件夹",demand:!1,type:"string"},target:{alias:"t",describe:"compile file target filepath | 生成的css文件存放路径",demand:!1,type:"string"},ext:{alias:"e",describe:"watched files ext | 要监听的文件拓展名，可用,分割",demand:!1,type:"string"},hot:{alias:"h",describe:"hot watch | 热更新",demand:!1,type:"string"}},async handler(e){const t=s.resolve(process.cwd(),e.config||"vno.config.js");try{await m.stat(t)}catch(e){return l.error("未找到配置文件，请先配置"),e}const i=await import(t),o={...p,...i.default};e.watch&&(o.watch=e.watch),e.target&&(o.target=e.target),e.ext&&(o.ext=e.ext),e.hot&&(o.hot=1==e.hot),l.success("配置加载成功，开始运行vnojs！"),g(o)}}).example("$0 init","init vno.config.js，初始化配置文件").example("$0 start -c v.config.js","start vno compile use v.config.js").example("$0 start","start vno compile use default config (vno.config.js)").wrap(null).argv;
